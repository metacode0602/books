## RAGæ•ˆæœè¯„ä¼°ï¼šRagasä½¿ç”¨è‡ªå®šä¹‰LLM

## å†™åœ¨å‰é¢

å¦‚æœä½ æ„å»ºäº†RAGæƒ³åº”ç”¨äºå®é™…ä¸šåŠ¡ç³»ç»Ÿï¼Œé‚£ä¹ˆä½ ä¸€å®šä¼šéå¸¸å…³æ³¨ã€ŒRAGåº”ç”¨çš„æ•ˆæœå¦‚ä½•ï¼Ÿã€ã€Œå¦‚ä½•æµ‹è¯„ï¼Ÿã€ï¼Œæœ¬æ–‡ä¼šä¸ºä½ æä¾›ä¸€å¥—å®Œæ•´æ–¹æ¡ˆã€‚

é€šç”¨RAGåº”ç”¨çš„æ­å»ºå¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š

- [æœå£³PAIï¼šä¸€æ–‡ææ‡‚å¤§æ¨¡å‹RAGåº”ç”¨ï¼ˆé™„å®è·µæ¡ˆä¾‹ï¼‰](https://zhuanlan.zhihu.com/p/668082024)
- [æœå£³PAIï¼šå¤§æ¨¡å‹è®°å¿†çš„æµ·é©¬ä½“â€”â€”å‘é‡æ•°æ®åº“](https://zhuanlan.zhihu.com/p/673543191)

é€šç”¨RAGåº”ç”¨æ­å»ºè¿‡ç¨‹ä¸­ä¼šæ¶‰åŠåˆ°å¾ˆå¤šé—®é¢˜ç‚¹ï¼Œä¾‹å¦‚å‘é‡æ•°æ®åº“é€‰æ‹©ã€Embeddingæ¨¡å‹é€‰æ‹©ã€chunkå‚æ•°é…ç½®ï¼ˆchunkå¤§å°ã€chunké‡åˆæ¯”ä¾‹ç­‰ï¼‰ã€ç›¸å…³æ€§é˜ˆå€¼ã€Top-Kç­‰ç­‰ã€‚

æœ¬æ–‡ä¸»è¦ä¾§é‡**RAGæµ‹è¯„æ–¹æ¡ˆ**ï¼Œä»¥åŠå¦‚ä½•åœ¨å¼€æºå·¥å…·RAGASåŸºç¡€ä¸Š**ä½¿ç”¨è‡ªå®šä¹‰çš„LLMè¿›è¡Œæµ‹è¯„ã€‚**

## 1ã€RAGè¯„ä¼°æ–¹æ¡ˆ

RAGæ•´ä¸ªç¯èŠ‚ä¸»è¦æ¶‰åŠåˆ°ä¸‰éƒ¨åˆ†å†…å®¹ï¼šè¾“å…¥queryã€æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡contextã€LLMçš„å›ç­”Responseï¼Œè¿™ä¹Ÿæ˜¯ RAG æ•´ä¸ªè¿‡ç¨‹ä¸­æœ€é‡è¦çš„ä¸‰å…ƒç»„ï¼Œå®ƒä»¬ä¹‹é—´ä¸¤ä¸¤ç›¸äº’ç‰µåˆ¶ã€‚å› æ­¤å¯ä»¥é€šè¿‡**æ£€æµ‹ä¸‰å…ƒç»„ä¹‹é—´ä¸¤ä¸¤å…ƒç´ çš„ç›¸å…³åº¦**ï¼Œæ¥è¯„ä¼°RAG åº”ç”¨çš„æ•ˆæœï¼š

![](../../assets/2024-04-18-08-05-45-image.png)

- **Context Relevance:**Â è¡¡é‡æ£€ç´¢çš„è´¨é‡çš„æŒ‡æ ‡ï¼Œä¸»è¦è¡¡é‡å¬å›çš„ chunk æ”¯æŒ Query çš„ç¨‹åº¦ã€‚å¦‚æœè¯¥å¾—åˆ†ä½ï¼Œååº”å‡ºäº†å¬å›äº†å¤ªå¤šä¸Query é—®é¢˜æ— å…³çš„å†…å®¹ï¼Œè¿™äº›é”™è¯¯çš„å¬å›çŸ¥è¯†ä¼šå¯¹ LLM çš„æœ€ç»ˆå›ç­”é€ æˆä¸€å®šå½±å“ã€‚
- **Groundedness:**Â è¡¡é‡ LLM çš„ Response éµä»å¬å›çš„ Context çš„ç¨‹åº¦çš„æŒ‡æ ‡ã€‚å¦‚æœè¯¥å¾—åˆ†ä½ï¼Œååº”å‡ºäº† LLM çš„å›ç­”ä¸éµä»å¬å›çš„çŸ¥è¯†ï¼Œé‚£ä¹ˆå›ç­”å‡ºç°å¹»è§‰çš„å¯èƒ½å°±è¶Šå¤§ã€‚
- **Answer Relevance:**Â è¡¡é‡æœ€ç»ˆçš„ Response å›ç­”å¯¹ Query æé—®çš„ç›¸å…³åº¦æŒ‡æ ‡ã€‚å¦‚æœè¯¥å¾—åˆ†ä½ï¼Œååº”å‡ºäº†å¯èƒ½ç­”ä¸å¯¹é¢˜ã€‚

### 1.1 å¦‚ä½•æ„é€ è¯„ä¼°æ•°æ®é›†ï¼Ÿ

åœ¨æ„å»ºå®ŒRAGåº”ç”¨åï¼Œæˆ‘ä»¬ä¸€èˆ¬åªæœ‰åˆ†æ®µåæ–‡æœ¬chunksï¼Œé‚£ä¹ˆå¦‚ä½•åªåŸºäºchunksæ„é€ æˆ‘ä»¬çš„è¯„æµ‹æ•°æ®é›†å‘¢ï¼Ÿç­”æ¡ˆæ˜¯â€”â€”**åˆ©ç”¨å¤§æ¨¡å‹è¿›è¡ŒQAæŒ–æ˜ã€‚**

å½“ç„¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›å¼€æºå·¥å…·ï¼Œä¹Ÿå¯ä»¥è‡ªå·±è®¾è®¡Promptå®ç°ï¼Œè¿™ä¸ªè¿‡ç¨‹å¹¶ä¸å›°éš¾ï¼Œå¯ä»¥ç®€å•è®¤ä¸ºæ˜¯ä¸€ä¸ªã€ŒPromptå·¥ç¨‹ã€è¿‡ç¨‹ã€‚ä½†æ— è®ºæ˜¯æ€ä¹ˆåšï¼Œå…¶åŸç†å¤§è‡´å¦‚ä¸‹ï¼š

![](../../assets/2024-04-18-08-06-34-image.png)

### 1.2 é€‰æ‹©è¯„æµ‹æŒ‡æ ‡

å¸¸ç”¨è¯„æµ‹æŒ‡æ ‡å¦‚ä¸‹ï¼š

![](../../assets/2024-04-18-08-07-10-image.png)

- ä¸Šä¸‹æ–‡ç›¸å…³æ€§ï¼ˆ**Context Relevancy**ï¼‰

è¯¥æŒ‡æ ‡è¡¡é‡å¬å›çš„Context æ”¯æŒ Query çš„ç¨‹åº¦ã€‚å¦‚æœè¯¥å¾—åˆ†ä½ï¼Œååº”å‡ºäº†å¬å›äº†å¤ªå¤šä¸Query é—®é¢˜æ— å…³çš„å†…å®¹ï¼Œè¿™äº›é”™è¯¯çš„å¬å›çŸ¥è¯†ä¼šå¯¹ LLM çš„æœ€ç»ˆå›ç­”é€ æˆä¸€å®šå½±å“ã€‚åœ¨RAGASä¸­ï¼Œæ˜¯ä»å¥å­ç²’åº¦ç»Ÿè®¡ç›¸å…³æ€§ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š

![](../../assets/2024-04-18-08-07-42-image.png)

- ä¸Šä¸‹æ–‡å¬å›ç‡ï¼ˆ**Context Recall**ï¼‰

è¯¥æŒ‡æ ‡è¡¡é‡æ£€ç´¢åˆ°çš„Contextä¸æ ‡æ³¨answerç­”æ¡ˆä¸€è‡´çš„ç¨‹åº¦ï¼Œè¢«è§†ä¸ºåŸºæœ¬äº‹å®ã€‚å®ƒæ˜¯åŸºäºåŸºæœ¬äº‹å®å’Œæ£€ç´¢åˆ°çš„Contextçš„ï¼Œå€¼çš„èŒƒå›´åœ¨0åˆ°1ä¹‹é—´ï¼Œå€¼è¶Šé«˜è¡¨ç¤ºæ€§èƒ½è¶Šå¥½ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š

![](https://pic2.zhimg.com/80/v2-a604137cd1a088b6f3e3f14318e86b0d_1440w.webp)

- ä¸Šä¸‹æ–‡ç²¾ç¡®åº¦ï¼ˆ**Context Precision**ï¼‰

è¯¥æŒ‡æ ‡è¡¡é‡æ£€ç´¢åˆ°çš„Contextä¸­å­˜åœ¨çš„æ‰€æœ‰åŸºæœ¬äº‹å®ç›¸å…³chunksçš„æ’åæ˜¯å¦æ›´é«˜çš„æŒ‡æ ‡ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ç›¸å…³chunkéƒ½å¿…é¡»å‡ºç°åœ¨æœ€é«˜çº§åˆ«ã€‚è¯¥åº¦é‡æ˜¯ä½¿ç”¨queryå’Œcontextè®¡ç®—çš„ï¼Œå€¼åœ¨0åˆ°1ä¹‹é—´ï¼Œå…¶ä¸­å¾—åˆ†è¶Šé«˜è¡¨ç¤ºç²¾åº¦è¶Šé«˜ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š

![](../../assets/2024-04-18-08-08-36-image.png)

- å¿ å®åº¦ï¼ˆ**Faithfulness/Groundedness**ï¼‰

è¯¥æŒ‡æ ‡è¡¡é‡ç”Ÿæˆçš„answerä¸ç»™å®šcontextçš„äº‹å®ä¸€è‡´æ€§ã€‚å®ƒæ˜¯æ ¹æ®answerå’Œæ£€ç´¢åˆ°çš„contextæ¥è®¡ç®—çš„ã€‚ç­”æ¡ˆæŒ‰æ¯”ä¾‹ç¼©æ”¾åˆ°ï¼ˆ0,1ï¼‰èŒƒå›´ï¼Œè¶Šé«˜è¶Šå¥½ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š

![](../../assets/2024-04-18-08-09-06-image.png)

- ç­”æ¡ˆç›¸å…³æ€§ï¼ˆ**Answer Relevancy**ï¼‰

è¯¥æŒ‡æ ‡è¡¡é‡ç”Ÿæˆçš„answerä¸ç»™å®šæç¤ºçš„ç›¸å…³æ€§ã€‚ä¸å®Œæ•´æˆ–åŒ…å«å†—ä½™ä¿¡æ¯çš„ç­”æ¡ˆå¾—åˆ†è¾ƒä½ã€‚è¯¥åº¦é‡æ˜¯ä½¿ç”¨queryå’Œanswerè®¡ç®—çš„ï¼Œå€¼åœ¨0åˆ°1ä¹‹é—´ï¼Œå…¶ä¸­å¾—åˆ†è¶Šé«˜è¡¨ç¤ºç›¸å…³æ€§è¶Šå¥½ã€‚

![](../../assets/2024-04-18-08-19-32-image.png)

## 2ã€ä½¿ç”¨RAGASè¯„ä¼°

### 2.1 æ•°æ®å°è£…

Ragasæµ‹è¯„éœ€è¦ä½¿ç”¨æ ‡å‡†çš„Datasetsæ•°æ®æ ¼å¼ï¼Œå› æ­¤éœ€è¦æå‰å°†è‡ªå®šä¹‰æ•°æ®é›†è¿›è¡Œå°è£…

```python
from datasets import Dataset

questions, answers, contexts, ground_truths = [], [], [], []
# å¡«å……è‡ªå·±çš„æ•°æ®å†…å®¹
evalsets = {
              "question": questions,
              "answer": answers,
              "contexts": contexts,
              "ground_truths": ground_truths
            }
evalsets = Dataset.from_dict(evalsets)
```

### 2.2 æŒ‡æ ‡é€‰æ‹©ä¸ä¸€é”®æµ‹è¯„

é€‰æ‹©éœ€è¦çš„è¯„æµ‹æŒ‡æ ‡ï¼Œå¹¶åˆ¶å®šæ•°æ®é›†è¿›è¡Œæµ‹è¯„ï¼ŒRagasé»˜è®¤ä½¿ç”¨ChatGPTï¼Œéœ€è¦æå‰é…ç½®openai-Key

```python
import os
from ragas import evaluate

os.environ["OPENAI_API_KEY"] = "your-openai-key"
from ragas.metrics import (
    answer_relevancy,
    faithfulness,
    context_recall,
    context_precision,
)

result = evaluate(
    evalsets,
    metrics=[
        context_precision,
        faithfulness,
        answer_relevancy,
        context_recall,
    ],
)

df = result.to_pandas()
df.head()
```

## 3ã€RAGASä½¿ç”¨è‡ªå®šä¹‰LLM

Ragasé»˜è®¤ä½¿ç”¨ChatGPTï¼Œç”¨è¿‡çš„éƒ½æ‡‚ï¼Œç”±äºå„æ–¹é¢åŸå› ï¼Œä½¿ç”¨å—åˆ°äº†é™åˆ¶....ã€‚é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨è‡ªå·±çš„LLMåœ¨Ragasæ¡†æ¶ä¸‹æµ‹è¯„å‘¢?

ç›´æ¥ä¸Šä»£ç ï½

```python
# ä»¥ä½¿ç”¨ERNIE-Botä¸ºï¼Œä½¿ç”¨qianfan-sdkå…ˆå®šä¹‰è‡ªå·±çš„æ¨¡å‹
from langchain_community.chat_models import QianfanChatEndpoint
from ragas.llms import LangchainLLM
from langchain_community.embeddings import QianfanEmbeddingsEndpoint

chat = QianfanChatEndpoint(model=model, qianfan_ak=QIANFAN_AK, qianfan_sk=QIANFAN_SK, **model_kwargs)
v_llm = LangchainLLM(chat)

v_embeddings = QianfanEmbeddingsEndpoint(
               qianfan_ak=QIANFAN_AK,
               qianfan_sk=QIANFAN_SK,
           )

# ç„¶åé‡æ–°æŒ‡å®šå„è¯„ä»·æŒ‡æ ‡ä½¿ç”¨çš„llm
from ragas import evaluate
from ragas.metrics import (
    answer_relevancy,
    faithfulness,
    context_recall,
    context_precision,
)

faithfulness.llm = vllm
answer_relevancy.llm = vllm
answer_relevancy.embeddings = v_embeddings

context_recall.llm = vllm
context_precision.llm = vllm

# é‡æ–°ä¸€é”®å¼æµ‹è¯„
result = evaluate(
    evalsets,
    metrics=[
        context_precision,
        faithfulness,
        answer_relevancy,
        context_recall,
    ],
)

df = result.to_pandas()
df.head()
```

## å‚è€ƒé“¾æ¥

- [https://www.trulens.org/trulens_eval/core_concepts_rag_triad/](https://link.zhihu.com/?target=https%3A//www.trulens.org/trulens_eval/core_concepts_rag_triad/)
- [https://github.com/explodinggra](https://link.zhihu.com/?target=https%3A//github.com/explodinggradients/ragas)
- [ğŸš€ Get Started | Ragas](https://docs.ragas.io/en/latest/getstarted/index.html)
